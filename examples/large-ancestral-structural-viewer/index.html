<!DOCTYPE html>
<html lang='en'>

<head>
  <meta charset="utf-8">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/spacelab/bootstrap.min.css">

  <link href="//veg.github.io/phylotree.js/phylotree.css" rel="stylesheet">

  <script src="//code.jquery.com/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="/phylotree.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js" charset="utf-8"></script>
  <script type='text/javascript' src='bio-pv.min.js'></script>
  <title>Ancestral Sequence Structural Viewer</title>
  <style>
    #guide {
      position: fixed;
      top: 0px;
      right: 50%;
      border-style: solid;
      border-color: black;
      border-width: 1px;
      background: white;
      margin-right: 5px;
    }
    #guide path.branch {
      opacity: .8;
      stroke: grey;
    }
    #guide path.branch:hover {
      stroke-width: 2px;
    }
    #structure-viewer {
      position: fixed;
      top: 0px;
      right: 0px;
      bottom: 0px;
      width: 50%;
      height: 100%;
      border-style: solid;
      border-color: black;
      border-width: 1px;
    }
    .top-margin {
      margin-top: 60px;
    }
    #red_selection {
      color: red;
    }
    #blue_selection {
      color: blue;
    }
  </style>


</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <a class="navbar-brand" href="#">Ancestral Sequence Structural Viewer</a>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav mx-auto">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Labels
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="selection_name_dropdown">
            <a id="red_selection" class="dropdown-item" href="#">Red selection</a>
            <a id="blue_selection" class="dropdown-item" href="#">Blue selection </a>
            <div class="dropdown-divider"></div>
            <a id="rename_selection" class="dropdown-item" href="#">Rename selection</a>
          </div>
        </li>

        <li>
          <form class="form-inline my-2 my-lg-0">
            <input type="text" id = 'selection_name_box' class="form-control mr-sm-2" value="Red selection" disabled size=40 style="color: red;">
          </form>
        </li>

        <li id="save_selection_name" style="display:none;" class="my-auto">
          <a href="#"><button id="cancel_selection_button" class="btn btn-info btn-sm">Cancel</button></a>
          <a href="#"><button id="save_selection_button" class="btn btn-info btn-sm">Save</button></a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Selection
          </a>
          <div class="dropdown-menu" aria-labelledby="navbarDropdown">
            <a id="select_all" class="dropdown-item" href="#">Select all</a>
            <a id="select_all_internal" class="dropdown-item" href="#">Select all internal nodes</a>
            <a id="select_all_leaves" class="dropdown-item" href="#">Select all leaf nodes</a>
            <a id="clear_internal" class="dropdown-item" href="#">Clear all internal nodes</a>
            <a id="clear_leaves" class="dropdown-item" href="#">Clear all leaves</a>
            <a id="select_none" class="dropdown-item" href="#">Clear selection</a>
            <div class="dropdown-divider"></div>
            <a id="mp_label" class="dropdown-item" href="#">Label internal nodes using maximum parsimony</a>
            <a id="and_label" class="dropdown-item" href="#">Label internal nodes using conjunction (AND)</a>
            <a id="or_label" class="dropdown-item" href="#">Label internal nodes using disjunction (OR)</a>
          </div>
        </li>
      </ul>
    </div>
  </nav>

  <div id="guide" class="top-margin">
    <svg id="tree_guide" />
  </div>
  <div id="structure-viewer" class="top-margin">
  </div>
  <svg id="tree_display" class="top-margin"/>

  <script>
    var current_selection = "red",
      names = { 
        red: "Red selection",
        blue: "Blue selection"
      },
      changes = {red: [], blue: []},
      change_colors = {
        none: [1, 1, 1],
        red: [1, 0, 0],
        blue: [0, 0, 1],
        purple: [1, 0, 1]
      },
      main_tree, guide_tree, parsed;
    d3.json("h3_substitutions.json", function(error, data) {
      main_tree = d3.layout.phylotree()
        // create a tree layout object
        .svg(d3.select("#tree_display"))
        .options({
          'show-scale': false,
          'left-right-spacing': 'fit-to-size',
          'top-bottom-spacing': 'fit-to-size',
          'collapsible': false,
          'brush': false,
          'reroot': false,
          'hide': false
        })
        .style_nodes(colorizer('black'))
        .size([38330, 38330/3]);
      // render to this SVG element
      parsed = d3.layout.newick_parser(data["tree"]);
      main_tree(parsed)
        // parse the Newick into a d3 hierarchy object with additional fields
        .layout();
      // layout and render the tree

      // Sort deepest clades towards bottom of tree
      var i = 0;
      main_tree.traverse_and_compute (function (n) {
        var d = 1;
        if (n.children && n.children.length) {
          d += d3.max (n.children, function (d) { return d["count_depth"];});
        }
        n["count_depth"] = d;
      });
      main_tree.resort_children (function (a,b) {
        return (a["count_depth"] - b["count_depth"]);
      });

      var guide_height = window.innerWidth/6,
        guide_width = window.innerWidth/6;

      d3.select('#guide')
        .style('height', guide_height+'px')
        .style('width', guide_width+'px');

      guide_tree = d3.layout.phylotree()
        .svg(d3.select("#tree_guide"))
        .options({
          'left-right-spacing': 'fit-to-size',
          // fit to given size top-to-bottom
          'top-bottom-spacing': 'fit-to-size',
          // fit to given size left-to-right
          'collapsible': false,
          // turn off the menu on internal nodes
          'transitions': false,
          // turn off d3 animations
          'show-scale': false,
          // disable brush
          'brush': false,
          // disable selections on this tree
          'selectable': false
        })
        .size([guide_height, guide_width])
        .node_circle_size(0);
      guide_tree(parsed)
        .layout();
    
      var x = d3.scale.linear()
        .domain([0, document.body.scrollWidth])
        .range([0, guide_width]);
      var y = d3.scale.linear()
        .domain([0, document.body.scrollHeight])
        .range([0, guide_height]);
      var rect = d3.select("#tree_guide")
        .append('rect')
          .attr('x', 0)
          .attr('y', 0)
          .style('opacity', .6)
          .attr('width', x(window.innerWidth/2))
          .attr('height', y(window.innerHeight));

      document.body.onscroll = function(event) {
        rect.attr('x', x(window.scrollX))
          .attr('y', y(window.scrollY));
      };

      d3.select('#guide').on("click", function() {
        var coords = d3.mouse(this),
          new_x = x.invert(coords[0])-window.innerWidth/4,
          new_y = y.invert(coords[1])-window.innerHeight/4;
        window.scrollTo(new_x, new_y);
      });

      main_tree.selection_callback(function(selected){
        guide_tree.sync_edge_labels();

        // color substitutions on structure
        var selected_node_names = _.pluck(selected, "name"),
          new_changes = _.uniq(_.flatten(_.values(_.pick(data, selected_node_names))))
            .map(d=>d+1),
          current_label = main_tree.selection_label();
        changes[current_label] = new_changes;
        var highlighter = new pv.color.ColorOp(function(atom, out, index) {
          var has_red_change = changes.red.indexOf(atom.residue().num()) > -1,
            has_blue_change = changes.blue.indexOf(atom.residue().num()) > -1,
            color = has_red_change ? ( has_blue_change ? 'purple' : 'red' ) : (has_blue_change ? 'blue' : 'none');
          out[index+0] = change_colors[color][0]; out[index+1] = change_colors[color][1];
          out[index+2] = change_colors[color][2]; out[index+3] = 1.0;
        });
        geom.colorBy(highlighter);
        viewer.requestRedraw();
      });

      var options = {
        width: 'auto',
        height: 'auto',
        antialias: true,
        quality : 'medium',
        background: '#EEE'
      };
      var parent = document.getElementById('structure-viewer');
      var viewer = pv.Viewer(parent, options);
      var geom;
      pv.io.fetchPdb("1ha0.pdb", function(structure) {
        geom = viewer.cartoon('protein', structure, {color: pv.color.uniform("white")});
        viewer.autoZoom();
      });

      main_tree.selection_label('red');
      guide_tree.selection_label('red');
      main_tree.style_edges(colorizer('grey'));
      guide_tree.style_edges(colorizer('grey'));
      main_tree.style_nodes(colorizer('black'));
    });

    $("#red_selection").on("click", function(e){
      current_selection = 'red';
      main_tree.selection_label('red');
      guide_tree.selection_label('red');
      d3.select("#selection_name_box")
        .style('color', 'red')
        .property('value', names['red']);
    });

    $("#blue_selection").on("click", function(e){
      current_selection = 'blue';
      main_tree.selection_label('blue');
      guide_tree.selection_label('blue');
      d3.select("#selection_name_box")
        .style('color', 'blue')
        .property('value', names['blue']);
    });

    $("#select_all").on ("click", function (e) {
      main_tree.modify_selection (function (d) { return true;});
    });

    $("#select_all_internal").on ("click", function (e) {
      main_tree.modify_selection (function (d) { return !d3.layout.phylotree.is_leafnode (d.target);});
    });

    $("#select_all_leaves").on ("click", function (e) {
      main_tree.modify_selection (function (d) { return d3.layout.phylotree.is_leafnode (d.target);});
    });


    $("#select_none").on ("click", function (e) {
      main_tree.modify_selection (function (d) { return false;});
    });

    $("#clear_internal").on ("click", function (e) {
      main_tree.modify_selection (function (d) {
        return d3.layout.phylotree.is_leafnode (d.target) ? d.target[current_selection] : false;
      });
    });

    $("#clear_leaves").on ("click", function (e) {
      main_tree.modify_selection (function (d) {
        return !d3.layout.phylotree.is_leafnode (d.target) ? d.target[current_selection] : false;
      });
    });

    $("#mp_label").on ("click", function (e) {
      main_tree.max_parsimony (true);
    });

    $("#and_label").on ("click", function (e) {
      main_tree.internal_label (function (d) {
        return d.reduce (function (prev, curr) { return curr[current_selection] && prev; }, true)
      }, true);
    });

    $("#or_label").on ("click", function (e) {
      main_tree.internal_label (function (d) {
        return d.reduce (function (prev, curr) { return curr[current_selection] || prev; }, false)
      }, true);
    });

    $("#rename_selection").on("click", function(e){
      d3.select('#save_selection_name')
        .style('display', null);
      d3.select('#selection_name_box')
       .attr('disabled', null); 
    });

    $("#cancel_selection_button").on("click", function(e){
      d3.select('#save_selection_name')
        .style('display', 'none');
      d3.select('#selection_name_box')
        .attr('disabled', true);
      $('#selection_name_box').val(names[current_selection]);
    });

    $("#save_selection_button").on("click", function(e){
      d3.select('#save_selection_name')
        .style('display', 'none');
      var new_name = $('#selection_name_box').val();
      $("#" + current_selection + "_selection").html(new_name);
      d3.select('#selection_name_box')
        .attr('disabled', true);
      names[current_selection] = new_name;
    });

    function colorizer(default_color) {
      return function (element, data) {
        var edge_stroke;
        if(data['red']){
          edge_stroke = data['blue'] ? "purple" : "red";
        } else {
          edge_stroke = data['blue'] ? "blue" : default_color;
        }
        element.style ("stroke", edge_stroke, "important");
      }
    }
  </script>

</body>

</html>
